<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ChatBot Plus Test Console</title>
  <style>
    body{font-family:Tahoma,Helvetica,sans-serif;background:#f7f7f7;margin:0;padding:0 1.2rem;color:#222}
    h1{font-size:1.4rem;margin:1rem 0}
    section{background:#fff;border:1px solid #ddd;border-radius:6px;padding:1rem;margin:1rem 0}
    label{display:block;margin:.5rem 0 .2rem}
    input,textarea,select,button{width:100%;padding:.4rem;border:1px solid #bbb;border-radius:4px;font-family:inherit}
    button{cursor:pointer;background:#0c7bd9;color:#fff;border:none;margin-top:.6rem}
    button:disabled{background:#888;cursor:not-allowed}
    .row{display:flex;gap:.6rem}
    .row>*{flex:1}
    pre{white-space:pre-wrap;background:#fafafa;border:1px solid #eee;padding:.6rem;border-radius:4px;font-size:.85rem;max-height:300px;overflow:auto}
  </style>
</head>
<body>

<h1>کنسول تست ChatBot Plus</h1>

<!-- احراز هویت -->
<section id="auth">
  <h2>۱) احراز هویت پیامکی</h2>
  <label>شماره موبایل</label>
  <input id="phone" placeholder="09xxxxxxxxx" />
  <button id="btnSendCode">ارسال کد</button>

  <label>کد تأیید</label>
  <input id="code" placeholder="----" />
  <button id="btnVerify">تأیید و دریافت Token</button>

  <p id="authStatus"></p>
</section>

<!-- کنسول ChatBot Plus -->
<section id="chatbot" style="display:none">
  <h2>۲) ابزارهای ChatBot Plus</h2>

  <div class="row">
    <button id="btnCreate">ایجاد جلسه</button>
    <select id="sessions"></select>
    <button id="btnRefreshList">بازآوری فهرست</button>
  </div>

  <label>پیام کاربر</label>
  <textarea id="msg" rows="3"></textarea>
  <button id="btnSendMsg">ارسال پیام</button>

  <div class="row">
    <button id="btnClose">بستن + خلاصه‌سازی</button>
    <button id="btnDetails">جزئیات جلسه</button>
  </div>

  <h3>پاسخ / خروجی</h3>
  <pre id="output"></pre>
</section>

<script>
const BASE = "http://localhost:8000";
const API  = BASE + "/api";
const CB   = API  + "/chatbot_plus";

const els = id => document.getElementById(id);
const output = els("output");
const tokenKey = "chatbot_token";

// ------------------------- احراز هویت -------------------------
els("btnSendCode").onclick = async () => {
  const phone = els("phone").value.trim();
  if(!phone) return alert("شماره را وارد کنید");
  try{
    const r = await fetch(`${API}/register/`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ phone_number: phone })
    });
    const json = await r.json();
    els("authStatus").textContent = json.success ? "کد ارسال شد" : (json.error || "خطا");
  } catch (err) { alert(err); }
};

els("btnVerify").onclick = async () => {
  const phone = els("phone").value.trim();
  const code  = els("code").value.trim();
  if(!phone||!code) return alert("اطلاعات ناقص");
  try{
    const r = await fetch(`${API}/verify/`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({phone_number:phone,code})
    });
    const j = await r.json();
    if(j.access){
      localStorage.setItem(tokenKey,j.access);
      els("auth").style.display="none";
      els("chatbot").style.display="block";
      loadSessions();
    }else{
      alert(j.error||"تأیید نشد");
    }
  }catch(e){alert(e)}
};

// ------------------------- ابزار مشترک -------------------------
function authHeaders(){
  const t = localStorage.getItem(tokenKey);
  return {"Authorization":"Bearer "+t,"Content-Type":"application/json"};
}
function show(o){ output.textContent = JSON.stringify(o,null,2); }

// ------------------------- فهرست جلسات -------------------------
async function loadSessions(){
  try{
    const r = await fetch(`${CB}/session/list/`,{headers:authHeaders()});
    const j = await r.json();
    const sel = els("sessions");
    sel.innerHTML="";
    j.sessions.forEach(s=>{
      const op=document.createElement("option");
      op.value=s.id; op.text=`${s.title||s.id} (${s.status})`;
      sel.appendChild(op);
    });
  }catch(e){console.error(e)}
}
els("btnRefreshList").onclick=loadSessions;

// ------------------------- ایجاد جلسه -------------------------
els("btnCreate").onclick = async ()=>{
  const r = await fetch(`${CB}/session/create/`,{
    method:"POST",headers:authHeaders()
  });
  show(await r.json());
  loadSessions();
};

// ------------------------- ارسال پیام -------------------------
els("btnSendMsg").onclick = async ()=>{
  const id=els("sessions").value;
  const txt=els("msg").value.trim();
  if(!id||!txt) return alert("پیام یا جلسه انتخاب نشده");
  const r = await fetch(`${CB}/session/${id}/messages/`,{
    method:"POST",headers:authHeaders(),
    body:JSON.stringify({content:txt})
  });
  show(await r.json());
};

// ------------------------- بستن جلسه -------------------------
els("btnClose").onclick = async ()=>{
  const id=els("sessions").value;
  if(!id) return;
  const r=await fetch(`${CB}/session/${id}/close/`,{
    method:"POST",headers:authHeaders()
  });
  show(await r.json()); loadSessions();
};

// ------------------------- جزئیات جلسه -------------------------
els("btnDetails").onclick = async ()=>{
  const id=els("sessions").value;
  if(!id) return;
  const r=await fetch(`${CB}/session/${id}/`,{headers:authHeaders()});
  show(await r.json());
};
</script>
</body>
</html>
